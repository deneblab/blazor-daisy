@namespace Deneblab.BlazorDaisy.Components.Snackbar
@rendermode InteractiveServer
@inject ISnackbarService SnackbarService
@implements IDisposable

<div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-sm">
    @foreach (var snackbar in _snackbars)
    {
        <div class="alert @GetAlertClass(snackbar.Severity) shadow-lg animate-fade-in">
            @GetIcon(snackbar.Severity)
            <span>@snackbar.Message</span>
            <button class="btn btn-ghost btn-xs" @onclick="() => Remove(snackbar.Id)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    }
</div>

@code {
    private readonly List<SnackbarMessage> _snackbars = new();
    private readonly Dictionary<Guid, Timer> _timers = new();

    protected override void OnInitialized()
    {
        SnackbarService.OnShow += HandleShow;
        SnackbarService.OnRemove += HandleRemove;
    }

    private void HandleShow(SnackbarMessage snackbar)
    {
        _snackbars.Add(snackbar);

        if (snackbar.DurationMs > 0)
        {
            var timer = new Timer(_ =>
            {
                InvokeAsync(() => Remove(snackbar.Id));
            }, null, snackbar.DurationMs, Timeout.Infinite);

            _timers[snackbar.Id] = timer;
        }

        InvokeAsync(StateHasChanged);
    }

    private void HandleRemove(Guid id)
    {
        Remove(id);
    }

    private void Remove(Guid id)
    {
        var snackbar = _snackbars.FirstOrDefault(s => s.Id == id);
        if (snackbar != null)
        {
            _snackbars.Remove(snackbar);

            if (_timers.TryGetValue(id, out var timer))
            {
                timer.Dispose();
                _timers.Remove(id);
            }

            InvokeAsync(StateHasChanged);
        }
    }

    private static string GetAlertClass(Severity severity) => severity switch
    {
        Severity.Success => "alert-success",
        Severity.Error => "alert-error",
        Severity.Warning => "alert-warning",
        Severity.Info => "alert-info",
        _ => "alert-info"
    };

    private static RenderFragment GetIcon(Severity severity) => severity switch
    {
        Severity.Success => @<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>,
        Severity.Error => @<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>,
        Severity.Warning => @<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>,
        _ => @<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    };

    public void Dispose()
    {
        SnackbarService.OnShow -= HandleShow;
        SnackbarService.OnRemove -= HandleRemove;

        foreach (var timer in _timers.Values)
        {
            timer.Dispose();
        }
        _timers.Clear();
    }
}
